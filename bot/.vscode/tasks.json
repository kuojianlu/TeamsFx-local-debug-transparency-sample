{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Pre Debug Check & Start All",
            "dependsOn": [
                "validate & install prerequisites",
                "install npm packages",
                "start local tunnel",
                "prepare local environment",
                "upload teams manifest",
                "start services"
            ],
            "dependsOrder": "sequence"
        },
        {
            "label": "validate & install prerequisites",
            "type": "shell",
            "command": "exit ${input:validate-and-install-prerequisites}",
            "presentation": {
                "reveal": "never"
            }
        },
        {
            "label": "install npm packages",
            "type": "shell",
            "command": "exit ${input:install-npm-packages}",
            "presentation": {
                "reveal": "silent"
            }
        },
        {
            "label": "start local tunnel",
            "type": "teamsfx",
            "command": "start-local-tunnel",
            "args": {
                "configFile": "${teamsfx:workspaceFolder}/.fx/configs/ngrok.yml",
                "binFolder": "${teamsfx:ngrokBinFolder}",
                "reuse": false
            },
            "isBackground": true,
            "problemMatcher": "$teamsfx-local-tunnel-watch",
            "presentation": {
                "reveal": "silent"
            }
        },
        {
            "label": "prepare local environment",
            "type": "shell",
            "command": "exit ${input:prepare-local-environment}",
            "presentation": {
                "reveal": "never"
            }
        },
        {
            "label": "upload teams manifest",
            "type": "shell",
            "command": "exit ${input:upload-teams-manifest}",
            "presentation": {
                "reveal": "never"
            }
        },
        {
            "label": "start services",
            "dependsOn": [
                "start bot"
            ]
        },
        {
            "label": "start bot",
            "type": "shell",
            "command": "npm run dev:teamsfx",
            "isBackground": true,
            "options": {
                "cwd": "${workspaceFolder}/bot"
            },
            "problemMatcher": {
                "pattern": [
                    {
                        "regexp": "^.*$",
                        "file": 0,
                        "location": 1,
                        "message": 2
                    }
                ],
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": "[nodemon] starting",
                    "endsPattern": "restify listening to|Bot/ME service listening at|[nodemon] app crashed"
                }
            }
        }
    ],
    "inputs": [
        {
            // This task helps to check the prerequisite to local debug the TeamsFx projects and install the missing dependencies in an easy way. What to check and how to check can be customized in the args section.
            "id": "validate-and-install-prerequisites",
            "type": "command",
            "command": "fx-extension.validate-and-install-prerequisites",
            // The args defined below is auto generated based on the project you scaffolded, to see full list of prerequisite check/installation options, see this page: https://aka.ms/teamsfx-prerequisite.
            "args": {
                "enabledCheckers": [
                    // NodeJs is used to start the project
                    "nodejs",
                    // Login M365 account is used for provision local resource
                    "m365Account",
                    // Ngrok us used to start the local tunnel
                    "ngrokBinary",
                    // Validate whether the ports are available
                    "portsOccupation"
                ],
                "portsOccupation": {
                    "botService": 3978,
                    "botDebug": 9239
                }
            }
        },
        {
            "id": "install-npm-packages",
            "type": "command",
            "command": "fx-extension.install-npm-packages",
            "args": {
                "bot": {
                    "npmInstallArgs": "--no-audit",
                    "cwd": "${teamsfx:workspaceFolder}/bot",
                    "forceUpdate": false
                }
            }
        },
        {
            "id": "prepare-local-environment",
            "type": "command",
            "command": "fx-extension.debug-task-prepare-local-environment",
            "args": {
                "enabledSteps": [
                    // register a bot in Bot Framework Portal
                    "registerBot",
                    // generate Teams app package according to the Teams manifest template in templates/appPackage/manifest.template.json
                    "buildTeamsManifest",
                ],
                "bot": {
                    "port": 3978,
                    // the environment variables for bot service will be appended to this file
                    "envSavePath": "${teamsfx:workspaceFolder}/bot/.env.teamsfx.local",
                    // the bot messaging endpoint will be configured to this value
                    "messagingEndpoint": "${teamsfx:botTunnelEndpoint}/api/messages"
                }
            }
        },
        {
            "id": "upload-teams-manifest",
            "type": "command",
            "command": "fx-extension.debug-task-upload-teams-manifest",
            "args": {
                // a Teams app will be registered according to this file
                "manifestZipPackage": "${teamsfx:workspaceFolder}/build/appPackage/appPackage.local.zip"
            }
        }
    ]
}
